<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload - Camera Fishing Effort</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé£ Camera Fishing Effort</h1>
            <p class="subtitle">Upload one or more images for analysis</p>
        </header>

        <main>
            <div class="upload-section">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="location-input-wrapper">
                        <label for="location" class="input-label">üìç Location</label>
                        <input 
                            type="text" 
                            name="location" 
                            id="location" 
                            placeholder="Enter fishing location..."
                            required
                            class="text-input"
                        >
                    </div>
                    
                    <div class="model-select-wrapper">
                        <label for="model_type" class="input-label">ü§ñ Detection Model</label>
                        <select 
                            name="model_type" 
                            id="model_type" 
                            required
                            class="text-input"
                        >
                            <option value="">-- Select a model --</option>
                            <option value="chokepoint">Chokepoint (In/Out Detection)</option>
                            <option value="fishing">Fishing (Boat Detection)</option>
                        </select>
                    </div>
                    
                    <div class="file-input-wrapper">
                        <label for="files" class="file-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span class="file-label-text">Choose images</span>
                        </label>
                        <input 
                            type="file" 
                            name="files" 
                            id="files" 
                            accept="image/*" 
                            multiple
                            required
                            class="file-input"
                        >
                    </div>
                    <button type="submit" class="upload-btn" id="upload-btn">
                        Upload Images
                    </button>
                </form>

                <div id="loading" class="htmx-indicator">
                    <div class="spinner"></div>
                    <p>Processing images...</p>
                </div>
            </div>

            <div id="result" class="result-section">
                <!-- Image previews will appear here -->
            </div>
        </main>

        <footer>
        </footer>
    </div>

    <script>
        // Disable upload button until model is selected
        const uploadBtn = document.getElementById('upload-btn');
        const modelSelect = document.getElementById('model_type');
        
        uploadBtn.disabled = true;
        modelSelect.addEventListener('change', function() {
            uploadBtn.disabled = !this.value;
        });
        
        // Show selected filenames/count
        document.getElementById('files').addEventListener('change', function(e) {
            const fileCount = e.target.files.length;
            if (fileCount > 0) {
                if (fileCount === 1) {
                    document.querySelector('.file-label-text').textContent = e.target.files[0].name;
                } else {
                    document.querySelector('.file-label-text').textContent = `${fileCount} images selected`;
                }
            }
        });

        // Handle form submission with fetch
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('files');
            const locationInput = document.getElementById('location');
            const modelInput = document.getElementById('model_type');
            
            // Add location and model to FormData
            formData.append('location', locationInput.value);
            formData.append('model_type', modelInput.value);
            
            // Add each file to FormData
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('result').innerHTML = html;
                } else {
                    document.getElementById('result').innerHTML = '<p style="color:red;">Upload failed. Please try again.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = '<p style="color:red;">Upload failed. Please try again.</p>';
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
